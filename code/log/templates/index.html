<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />


    <title>Sadia's Motion Detector</title>


    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>

<body onload="createTables()">
    <center>
        <div id="table"></div>
        <div id="curve_chart" style="width: 1200px; height: 1200px"></div>
    </center> 
    
    <script type='text/javascript'>
        //load google chart libraries
        google.charts.load('current', {packages: ['corechart']});
        
        //create empty array as a global
        var chartData = [];
        //var to count people in room
        //var count = 0;

        //create function that will be called when the page is loaded    
        function createTables(){
            goTime = new Date();
            console.log('It\'s Go Time! '+goTime);
            getData();
            setInterval(function() {
					xTime = new Date();
					console.clear();
					console.log('Update Initiated: '+xTime);
					getData();
				}, 60000);
        }

        //get data from @app.route("/sqlData") and push into array
        function getData(){
            //clear array(or else it will keep adding to the previous data already in the array)
            chartData = [];
            $.getJSON('sqlData', function(chartJSON){
                for(i=0;i<chartJSON.length; i++){
                    chartData.push([new Date(chartJSON[i].Time), chartJSON[i].Place, chartJSON[i].Count]);
                };
                tableChart();
                drawChart();
            });
        }

        //function to create table and draw chart
        function tableChart(){
            var currentCount = chartData[chartData.length-1][2];
            //create table
            var tableTemp = $('<table></table>').attr({ id: "tableTemp" });
            //create tags 
            //append the header labels time, type of entry, and total people
            var head = $('<tr></tr>').attr({ class: ['head'].join(' ')}).appendTo(tableTemp);
		    $('<td></td>').text('Time').appendTo(head);
		    $('<td></td>').text('Type of entry').appendTo(head);
            $('<td></td>').text('Total people').appendTo(head);	
            

            $("#tableTemp").remove();
            $("#count").remove();
    
            //append data to tempTable then append tempTable to the original table
            for (var line in chartData) {
                var row = $('<tr></tr>').attr({ class: "row-class" }).appendTo(tableTemp);
                    row.appendTo(tableTemp)
                    $('<td></td>').text(chartData[line][0]).appendTo(row);
                    $('<td></td>').text(chartData[line][1]).appendTo(row);
                    $('<td></td>').text(chartData[line][2]).appendTo(row);


            }

            var count = $("<h1></h1>").text("Number of people currently in the room: " + currentCount).attr({id: 'count'}).appendTo("#table");
	        tableTemp.appendTo("#table")
        }

        //function to draw chart
        function drawChart(){
            //chart
                       
            var gdata = new google.visualization.DataTable();
            gdata.addColumn('date', 'Time');
            //gdata.addColumn('string', 'Place');
            gdata.addColumn('number', 'Count');
            for(i=0; i < chartData.length; i++){
                gdata.addRow([chartData[i][0], chartData[i][2]])

            }
            console.log(chartData)
            //gdata.addRows(chartData);
            console.log(gdata);
            var options ={
                title: 'Motion detection',
                curveType: 'function',
                legend: { position: 'bottom'}
            };
            var chart = new google.visualization.ColumnChart(document.getElementById('curve_chart'));
            chart.draw(gdata, options);
            chartTime = new Date();
        }

    </script>

</body>

</html>